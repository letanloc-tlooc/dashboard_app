{% extends "index.html" %} {% block content %}
<body class="container py-4">
  <!-- Upload Form -->
  <form
    id="uploadForm"
    method="POST"
    enctype="multipart/form-data"
    class="row g-2 mb-4"
  >
    <div class="col-12 col-md-6">
      <input
        type="file"
        name="file"
        id="fileInput"
        class="form-control"
        required
      />
    </div>
    <div class="col-6 col-md-3">
      <button class="btn btn-success w-100">📥 Tải lên</button>
    </div>
    {% if table_html %}
    <div class="col-6 col-md-3">
      <button
        type="button"
        class="btn btn-danger w-100"
        data-bs-toggle="modal"
        data-bs-target="#confirmDeleteModal"
      >
        ❌ Xóa dữ liệu
      </button>
    </div>
    {% endif %}
  </form>
  <!-- Bảng dữ liệu -->
  <div class="table-responsive mb-4">{{ table_html | safe }}</div>
  {% if table_html %}
  <!-- Thông tin dữ liệu -->
  <div class="row text-center mb-3">
    <div class="col-md-4">
      <div class="alert alert-info">🔢 Số dòng: <strong>{{ r }}</strong></div>
    </div>
    <div class="col-md-4">
      <div class="alert alert-info">🔠 Số cột: <strong>{{ d }}</strong></div>
    </div>
    <div class="col-md-4">
      {% if total_missing == 0 %}
      <div class="alert alert-success">✅ Không có dữ liệu thiếu</div>
      {% else %}
      <div class="alert alert-warning">
        ❗ Có <strong>{{ total_missing }}</strong> ô thiếu:
        <ul class="text-start mb-0">
          {% for col, count in missing_cols.items() %}
          <li><strong>{{ col }}</strong>: {{ count }} ô</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Trực quan 1 thuộc tính -->
  <form action="/chart" method="POST" class="mb-3">
    <label class="form-label"
      >📌 Chọn thuộc tính bất kỳ để trực quan hóa:</label
    >
    <select name="selected_col" class="form-select mb-2" required>
      {% for col in columns %}
      <option value="{{ col }}">{{ col }}</option>
      {% endfor %}
    </select>
    <button class="btn btn-primary w-100">📊 Vẽ biểu đồ</button>
  </form>

  <!-- Thống kê mô tả -->
  <form action="/describe" method="POST" class="mb-3">
    <label class="form-label">📌 Chọn thuộc tính số để thống kê mô tả:</label>
    <select name="selected_col" class="form-select mb-2" required>
      {% for col in numeric_columns %}
      <option value="{{ col }}">{{ col }}</option>
      {% endfor %}
    </select>
    <button class="btn btn-warning w-100">📈 Xem mô tả</button>
  </form>

  <!-- Trực quan 2 thuộc tính phân loại -->
  <form action="/plot_categorical" method="POST" class="row g-2 my-4">
    <div class="col-md-5">
      <label class="form-label">🟨 Cột phân loại X:</label>
      <select name="col1" class="form-select" required>
        {% for col in categorical_columns %}
        <option value="{{ col }}">{{ col }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-5">
      <label class="form-label">🟧 Phân nhóm (Hue):</label>
      <select name="col2" class="form-select" required>
        {% for col in categorical_columns %}
        <option value="{{ col }}">{{ col }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button class="btn btn-warning w-100">Hiển thị biểu đồ nhóm</button>
    </div>
  </form>

  <!-- Heatmap -->
  <form action="/heatmap" method="GET" class="text-end mt-3">
    <button class="btn btn-danger">🔍 Xem biểu đồ tương quan (Heatmap)</button>
  </form>

  <!-- Biểu đồ phân loại vs định lượng -->
  <form action="/plot_cate_num" method="POST" class="row g-3 my-4">
    <div class="col-md-5">
      <label class="form-label">🧩 Cột phân loại:</label>
      <select
        name="col_cat"
        id="col_cat"
        class="form-select"
        onchange="updateNumericOptions()"
        required
      >
        {% for col in categorical_columns %}
        <option value="{{ col }}">{{ col }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-5">
      <label class="form-label">📏 Cột định lượng:</label>
      <select name="col_num" id="col_num" class="form-select" required>
        {% for col in quantitative_columns %}
        <option value="{{ col }}">{{ col }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2 d-flex align-items-end">
      <button class="btn btn-success w-100">Vẽ biểu đồ</button>
    </div>
  </form>
  {% endif %}
  <form action="/handle_missing_columns" method="POST" class="my-4">
    <h5 class="mb-3">🛠️ Xử lý dữ liệu thiếu theo cột:</h5>
    {% set _missing_cols = missing_cols | default({}) %} {% for col, count in
    _missing_cols.items() %}
    <div class="mb-2">
      <label><strong>{{ col }}</strong> ({{ count }} ô thiếu):</label>
      <select name="strategy_{{ col }}" class="form-select mt-1">
        <option value="">-- Không xử lý --</option>
        <option value="drop">❌ Xóa dòng</option>
        <option value="mean">📊 Thay bằng trung bình</option>
        <option value="median">📈 Thay bằng trung vị</option>
      </select>
    </div>
    {% endfor %}
    <button class="btn btn-secondary mt-3">🚀 Thực hiện xử lý</button>
  </form>

  <!-- Modal xác nhận xóa -->
  <div
    class="modal fade"
    id="confirmDeleteModal"
    tabindex="-1"
    aria-labelledby="deleteModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-danger">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="deleteModalLabel">
            🚨 Xác nhận xóa dữ liệu
          </h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body">
          Bạn có chắc chắn muốn <strong>xóa dữ liệu đã tải lên</strong> không?
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Hủy
          </button>
          <a href="{{ url_for('clear_data') }}" class="btn btn-danger"
            >Xác nhận xóa</a
          >
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // Validate file extension
    document.getElementById("uploadForm").addEventListener("submit", function (e) {
      const fileInput = document.getElementById("fileInput");
      const file = fileInput.files[0];
      if (!file) return;

      const allowedExtensions = ['csv', 'xlsx', 'xls'];
      const fileExt = file.name.split('.').pop().toLowerCase();
      if (!allowedExtensions.includes(fileExt)) {
        e.preventDefault();
        Swal.fire({
          icon: 'error',
          title: '❌ Không đúng định dạng!',
          text: 'Chỉ được tải lên file .csv, .xls hoặc .xlsx!',
          confirmButtonColor: '#3085d6',
          confirmButtonText: 'OK!'
        });
      }
    });

    // Filter định lượng khi chọn phân loại
    const categorical = {{ categorical_columns | default([]) | tojson }};
    const numeric = {{ numeric_columns | default([]) | tojson }};

    function updateNumericOptions() {
      const selectedCat = document.getElementById("col_cat").value;
      const numericSelect = document.getElementById("col_num");
      numericSelect.innerHTML = "";

      numeric.forEach(col => {
        if (!categorical.includes(col)) {
          const opt = document.createElement("option");
          opt.value = col;
          opt.textContent = col;
          numericSelect.appendChild(opt);
        }
      });
    }
  </script>
</body>
{% endblock %}
