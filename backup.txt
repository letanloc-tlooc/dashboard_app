<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>ğŸ“Š Trá»±c quan dá»¯ liá»‡u CSV</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>

  <body class="container py-4">
    <h2 class="text-center mb-4">ğŸ“„ Upload File & PhÃ¢n tÃ­ch dá»¯ liá»‡u</h2>

    <!-- Upload Form -->
    <form
      id="uploadForm"
      method="POST"
      enctype="multipart/form-data"
      class="row g-2 mb-4"
    >
      <div class="col-12 col-md-6">
        <input
          type="file"
          name="file"
          id="fileInput"
          class="form-control"
          required
        />
      </div>
      <div class="col-6 col-md-3">
        <button class="btn btn-success w-100">ğŸ“¥ Táº£i lÃªn</button>
      </div>
      {% if table_html %}
      <div class="col-6 col-md-3">
        <button
          type="button"
          class="btn btn-danger w-100"
          data-bs-toggle="modal"
          data-bs-target="#confirmDeleteModal"
        >
          âŒ XÃ³a dá»¯ liá»‡u
        </button>
      </div>
      {% endif %}
    </form>

    {% if table_html %}
    <!-- ThÃ´ng tin dá»¯ liá»‡u -->
    <div class="row text-center mb-3">
      <div class="col-md-4">
        <div class="alert alert-info">ğŸ”¢ Sá»‘ dÃ²ng: <strong>{{ r }}</strong></div>
      </div>
      <div class="col-md-4">
        <div class="alert alert-info">ğŸ”  Sá»‘ cá»™t: <strong>{{ d }}</strong></div>
      </div>
      <div class="col-md-4">
        {% if total_missing == 0 %}
        <div class="alert alert-success">âœ… KhÃ´ng cÃ³ dá»¯ liá»‡u thiáº¿u</div>
        {% else %}
        <div class="alert alert-warning">
          â— CÃ³ <strong>{{ total_missing }}</strong> Ã´ thiáº¿u:
          <ul class="text-start mb-0">
            {% for col, count in missing_cols.items() %}
            <li><strong>{{ col }}</strong>: {{ count }} Ã´</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Báº£ng dá»¯ liá»‡u -->
    <div class="table-responsive mb-4">{{ table_html | safe }}</div>

    <!-- Trá»±c quan 1 thuá»™c tÃ­nh -->
    <form action="/chart" method="POST" class="mb-3">
      <label class="form-label"
        >ğŸ“Œ Chá»n thuá»™c tÃ­nh báº¥t ká»³ Ä‘á»ƒ trá»±c quan hÃ³a:</label
      >
      <select name="selected_col" class="form-select mb-2" required>
        {% for col in columns %}
        <option value="{{ col }}">{{ col }}</option>
        {% endfor %}
      </select>
      <button class="btn btn-primary w-100">ğŸ“Š Váº½ biá»ƒu Ä‘á»“</button>
    </form>

    <!-- Thá»‘ng kÃª mÃ´ táº£ -->
    <form action="/describe" method="POST" class="mb-3">
      <label class="form-label">ğŸ“Œ Chá»n thuá»™c tÃ­nh sá»‘ Ä‘á»ƒ thá»‘ng kÃª mÃ´ táº£:</label>
      <select name="selected_col" class="form-select mb-2" required>
        {% for col in numeric_columns %}
        <option value="{{ col }}">{{ col }}</option>
        {% endfor %}
      </select>
      <button class="btn btn-warning w-100">ğŸ“ˆ Xem mÃ´ táº£</button>
    </form>

    <!-- Trá»±c quan 2 thuá»™c tÃ­nh phÃ¢n loáº¡i -->
    <form action="/plot_categorical" method="POST" class="row g-2 my-4">
      <div class="col-md-5">
        <label class="form-label">ğŸŸ¨ Cá»™t phÃ¢n loáº¡i X:</label>
        <select name="col1" class="form-select" required>
          {% for col in categorical_columns %}
          <option value="{{ col }}">{{ col }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-5">
        <label class="form-label">ğŸŸ§ PhÃ¢n nhÃ³m (Hue):</label>
        <select name="col2" class="form-select" required>
          {% for col in categorical_columns %}
          <option value="{{ col }}">{{ col }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button class="btn btn-warning w-100">Hiá»ƒn thá»‹ biá»ƒu Ä‘á»“ nhÃ³m</button>
      </div>
    </form>

    <!-- Heatmap -->
    <form action="/heatmap" method="GET" class="text-end mt-3">
      <button class="btn btn-danger">
        ğŸ” Xem biá»ƒu Ä‘á»“ tÆ°Æ¡ng quan (Heatmap)
      </button>
    </form>

    <!-- Biá»ƒu Ä‘á»“ phÃ¢n loáº¡i vs Ä‘á»‹nh lÆ°á»£ng -->
    <form action="/plot_cate_num" method="POST" class="row g-3 my-4">
      <div class="col-md-5">
        <label class="form-label">ğŸ§© Cá»™t phÃ¢n loáº¡i:</label>
        <select
          name="col_cat"
          id="col_cat"
          class="form-select"
          onchange="updateNumericOptions()"
          required
        >
          {% for col in categorical_columns %}
          <option value="{{ col }}">{{ col }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-5">
        <label class="form-label">ğŸ“ Cá»™t Ä‘á»‹nh lÆ°á»£ng:</label>
        <select name="col_num" id="col_num" class="form-select" required>
          {% for col in quantitative_columns %}
          <option value="{{ col }}">{{ col }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2 d-flex align-items-end">
        <button class="btn btn-success w-100">Váº½ biá»ƒu Ä‘á»“</button>
      </div>
    </form>
    {% endif %}
    <form action="/handle_missing_columns" method="POST" class="my-4">
      <h5 class="mb-3">ğŸ› ï¸ Xá»­ lÃ½ dá»¯ liá»‡u thiáº¿u theo cá»™t:</h5>
      {% set _missing_cols = missing_cols | default({}) %} {% for col, count in
      _missing_cols.items() %}
      <div class="mb-2">
        <label><strong>{{ col }}</strong> ({{ count }} Ã´ thiáº¿u):</label>
        <select name="strategy_{{ col }}" class="form-select mt-1">
          <option value="">-- KhÃ´ng xá»­ lÃ½ --</option>
          <option value="drop">âŒ XÃ³a dÃ²ng</option>
          <option value="mean">ğŸ“Š Thay báº±ng trung bÃ¬nh</option>
          <option value="median">ğŸ“ˆ Thay báº±ng trung vá»‹</option>
        </select>
      </div>
      {% endfor %}
      <button class="btn btn-secondary mt-3">ğŸš€ Thá»±c hiá»‡n xá»­ lÃ½</button>
    </form>

    <!-- Modal xÃ¡c nháº­n xÃ³a -->
    <div
      class="modal fade"
      id="confirmDeleteModal"
      tabindex="-1"
      aria-labelledby="deleteModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-danger">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="deleteModalLabel">
              ğŸš¨ XÃ¡c nháº­n xÃ³a dá»¯ liá»‡u
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n <strong>xÃ³a dá»¯ liá»‡u Ä‘Ã£ táº£i lÃªn</strong> khÃ´ng?
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Há»§y
            </button>
            <a href="{{ url_for('clear_data') }}" class="btn btn-danger"
              >XÃ¡c nháº­n xÃ³a</a
            >
          </div>
        </div>
      </div>
    </div>

    <!-- JavaScript -->
    <script>
      // Validate file extension
      document.getElementById("uploadForm").addEventListener("submit", function (e) {
        const fileInput = document.getElementById("fileInput");
        const file = fileInput.files[0];
        if (!file) return;

        const allowedExtensions = ['csv', 'xlsx', 'xls'];
        const fileExt = file.name.split('.').pop().toLowerCase();
        if (!allowedExtensions.includes(fileExt)) {
          e.preventDefault();
          Swal.fire({
            icon: 'error',
            title: 'âŒ KhÃ´ng Ä‘Ãºng Ä‘á»‹nh dáº¡ng!',
            text: 'Chá»‰ Ä‘Æ°á»£c táº£i lÃªn file .csv, .xls hoáº·c .xlsx!',
            confirmButtonColor: '#3085d6',
            confirmButtonText: 'OK!'
          });
        }
      });

      // Filter Ä‘á»‹nh lÆ°á»£ng khi chá»n phÃ¢n loáº¡i
      const categorical = {{ categorical_columns | default([]) | tojson }};
      const numeric = {{ numeric_columns | default([]) | tojson }};

      function updateNumericOptions() {
        const selectedCat = document.getElementById("col_cat").value;
        const numericSelect = document.getElementById("col_num");
        numericSelect.innerHTML = "";

        numeric.forEach(col => {
          if (!categorical.includes(col)) {
            const opt = document.createElement("option");
            opt.value = col;
            opt.textContent = col;
            numericSelect.appendChild(opt);
          }
        });
      }
    </script>
  </body>
</html>
